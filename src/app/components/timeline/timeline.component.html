<div class="timeline-container">
  <!-- Scroll to Today Button (only show when more than 1 month away) -->
  <button
    *ngIf="showScrollToToday()"
    mat-fab
    class="today-button"
    (click)="scrollToToday()"
    aria-label="Scroll to today">
    <mat-icon>today</mat-icon>
  </button>

  <!-- Timeline Viewport -->
  <div #scrollContainer class="timeline-viewport" (scroll)="onScroll()">
    <!-- Top sentinel for infinite scroll detection -->
    <div #topSentinel class="scroll-sentinel"></div>

    <div *ngFor="let timelineDate of timelineDates(); trackBy: trackByDateKey"
         class="timeline-item">

      <!-- Skip Indicator -->
      <div *ngIf="entryService.showDaysIndicator() && timelineDate.daysSkipped && timelineDate.daysSkipped > 0"
           class="skip-indicator">
        <div class="skip-line"></div>
        <div class="skip-label">{{ timelineDate.daysSkipped }} days</div>
        <div class="skip-line"></div>
      </div>

      <!-- Date Row -->
      <div class="date-row"
           [class.today]="timelineDate.isToday"
           [matTooltip]="isMobile() ? '' : timelineDate.balanceTooltip"
           [matTooltipClass]="timelineDate.balanceTooltipClass"
           matTooltipPosition="left"
           [matTooltipShowDelay]="300"
           [matTooltipHideDelay]="0"
           (click)="onDateRowClick(timelineDate.date)">
        <!-- Date Label -->
        <div class="date-label">
          {{ timelineDate.displayDate }}
        </div>

        <!-- Connector Column -->
        <div class="connector-column">
          <div class="connector-line"></div>
        </div>

        <!-- Entries Column -->
        <div class="entries-column">
          <!-- Show entries if any exist -->
          <div *ngIf="timelineDate.entries.length > 0" class="entries-list">
            <div *ngFor="let occurrence of timelineDate.entries; let last = last"
                 class="entry-item"
                 [class.income]="occurrence.entry.type === 'income'"
                 [class.expense]="occurrence.entry.type === 'expense'"
                 (click)="onEntryClick(occurrence.entry, occurrence.date, $event)">

              <div class="entry-content">
                <div class="entry-label">{{ occurrence.entry.label }}</div>
                <div *ngIf="occurrence.entry.note" class="entry-note">{{ occurrence.entry.note }}</div>
              </div>
              <div class="entry-amount">
                {{ occurrence.amountFormatted }}
              </div>
            </div>
          </div>

          <!-- Show empty state if no entries -->
          <div *ngIf="timelineDate.entries.length === 0" class="no-entries">
            <div class="empty-connector">â”‚</div>
          </div>
        </div>
      </div>

      <!-- Balance Indicator -->
      <div *ngIf="timelineDate.showBalanceIndicator" class="balance-indicator">
        <div class="balance-line"></div>
        <div class="balance-content"
             [class.balance-up]="timelineDate.balanceChange === 'up'"
             [class.balance-down]="timelineDate.balanceChange === 'down'">
          <mat-icon *ngIf="timelineDate.balanceChange === 'up'" class="balance-arrow">arrow_upward</mat-icon>
          <mat-icon *ngIf="timelineDate.balanceChange === 'down'" class="balance-arrow">arrow_downward</mat-icon>
          <span class="balance-value">{{ timelineDate.balanceFormatted }}</span>
        </div>
        <div class="balance-line"></div>
      </div>

      <!-- Month-End Balance Row -->
      <div *ngIf="timelineDate.isMonthEnd" class="month-end-balance-row">
        <div class="month-end-label">
          Balance as of {{ timelineDate.monthEndDateFormatted }}
        </div>
        <div class="month-end-amount"
             [class.positive]="timelineDate.monthEndArrow === 'up'"
             [class.negative]="timelineDate.monthEndArrow === 'down'">
          <mat-icon *ngIf="timelineDate.monthEndArrow === 'up'" class="month-end-arrow arrow-up">arrow_upward</mat-icon>
          <mat-icon *ngIf="timelineDate.monthEndArrow === 'down'" class="month-end-arrow arrow-down">arrow_downward</mat-icon>
          {{ timelineDate.balanceFormatted }}
        </div>
      </div>

      <!-- Month Header (shown after month-end balance) -->
      <div *ngIf="timelineDate.isMonthEnd"
           class="month-header"
           [class.current-month]="timelineDate.isCurrentMonth">
        {{ timelineDate.nextMonthYear }}
      </div>

    </div>

    <!-- Bottom sentinel for infinite scroll detection -->
    <div #bottomSentinel class="scroll-sentinel"></div>
  </div>
</div>
